name: Renovate Migration Automation

on:
  pull_request:
    types: [labeled, opened, synchronize]
  workflow_dispatch: # Allows manual triggering for testing

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  check-conditions:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.result }}
      pr_number: ${{ steps.pr.outputs.number }}
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Get PR number
        id: pr
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            # For push events, find the PR associated with this branch
            PR_NUMBER=$(gh pr list --head "${{ github.ref_name }}" --json number -q '.[0].number')
            echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Check if workflow should run
        id: check
        run: |
          # For pull_request events, use head_ref (source branch name)
          # For other events, use ref_name
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BRANCH_NAME="${{ github.head_ref }}"
          else
            BRANCH_NAME="${{ github.ref_name }}"
          fi

          echo "Checking branch: $BRANCH_NAME"

          # Check if branch starts with renovate/
          if [[ ! "$BRANCH_NAME" =~ ^renovate/ ]]; then
            echo "result=false" >> $GITHUB_OUTPUT
            echo "Branch $BRANCH_NAME does not start with renovate/"
            exit 0
          fi

          # Check if PR has migrate-auto label
          if [ -n "${{ steps.pr.outputs.number }}" ]; then
            LABELS=$(gh pr view ${{ steps.pr.outputs.number }} --json labels -q '.labels[].name')
            if echo "$LABELS" | grep -q "migrate-auto"; then
              echo "result=true" >> $GITHUB_OUTPUT
              echo "Branch is renovate/* and PR has migrate-auto label"
            else
              echo "result=false" >> $GITHUB_OUTPUT
              echo "PR does not have migrate-auto label"
            fi
          else
            echo "result=false" >> $GITHUB_OUTPUT
            echo "No PR found for this branch"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

  build-and-detect:
    needs: check-conditions
    if: needs.check-conditions.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    outputs:
      has_errors: ${{ steps.build.outputs.has_errors }}
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            functions/node_modules
            ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Create credentials file for functions build
        run: |
          if [ -n "$FUNCTIONS_CREDENTIALS" ]; then
            echo "$FUNCTIONS_CREDENTIALS" > functions/src/credentials.ts
            echo "✓ Created functions/src/credentials.ts from secret"
          else
            echo "⚠ FUNCTIONS_CREDENTIALS secret not set - functions build may fail"
          fi
        env:
          FUNCTIONS_CREDENTIALS: ${{ secrets.FUNCTIONS_CREDENTIALS }}

      - name: Install dependencies and build
        id: build
        continue-on-error: true
        run: |
          chmod +x .github/scripts/capture-errors.sh
          ./.github/scripts/capture-errors.sh
          echo "Script completed with exit code: $?"

      - name: Upload error logs
        if: steps.build.outputs.has_errors == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: error-logs
          path: |
            install-errors.log
            functions-install-errors.log
            build-errors.log
            functions-errors.log
          retention-days: 7

      - name: Comment on PR if no errors
        if: steps.build.outputs.has_errors == 'false'
        run: |
          gh pr comment ${{ needs.check-conditions.outputs.pr_number }} --body "✅ **Build passed!**

          No migration errors detected. The Renovate update appears to be compatible without code changes."
        env:
          GH_TOKEN: ${{ github.token }}

  claude-fix:
    needs: [check-conditions, build-and-detect]
    if: needs.build-and-detect.outputs.has_errors == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Create credentials file for functions build
        run: |
          if [ -n "$FUNCTIONS_CREDENTIALS" ]; then
            echo "$FUNCTIONS_CREDENTIALS" > functions/src/credentials.ts
            echo "✓ Created functions/src/credentials.ts from secret"
          else
            echo "⚠ FUNCTIONS_CREDENTIALS secret not set - functions build may fail"
          fi
        env:
          FUNCTIONS_CREDENTIALS: ${{ secrets.FUNCTIONS_CREDENTIALS }}

      - name: Download error logs
        uses: actions/download-artifact@v4
        with:
          name: error-logs

      - name: Generate Claude prompt
        id: prompt
        run: |
          chmod +x .github/scripts/generate-claude-prompt.sh
          PROMPT=$(./.github/scripts/generate-claude-prompt.sh)

          # Save prompt to file for Claude Code Action
          echo "$PROMPT" > claude-prompt.txt
          echo "Prompt generated and saved to claude-prompt.txt"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Run Claude Code to fix errors
        id: claude
        continue-on-error: true
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            $(cat claude-prompt.txt)
          claude_args: "--permission-mode bypassPermissions --max-turns 30 --model claude-sonnet-4-5-20250929"
          show_full_output: true

  verify-build:
    needs: [check-conditions, claude-fix]
    if: always() && needs.check-conditions.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Create credentials file for functions build
        run: |
          if [ -n "$FUNCTIONS_CREDENTIALS" ]; then
            echo "$FUNCTIONS_CREDENTIALS" > functions/src/credentials.ts
            echo "✓ Created functions/src/credentials.ts from secret"
          else
            echo "⚠ FUNCTIONS_CREDENTIALS secret not set - functions build may fail"
          fi
        env:
          FUNCTIONS_CREDENTIALS: ${{ secrets.FUNCTIONS_CREDENTIALS }}

      - name: Install dependencies
        run: |
          npm ci
          cd functions && npm ci

      - name: Verify frontend build
        id: verify-frontend
        continue-on-error: true
        run: npm run build

      - name: Verify functions build
        id: verify-functions
        continue-on-error: true
        run: cd functions && npm run build

      - name: Report results
        run: |
          FRONTEND_STATUS="${{ steps.verify-frontend.outcome }}"
          FUNCTIONS_STATUS="${{ steps.verify-functions.outcome }}"

          if [ "$FRONTEND_STATUS" == "success" ] && [ "$FUNCTIONS_STATUS" == "success" ]; then
            MESSAGE="✅ **Migration successful!**

            All builds are passing after Claude Code's fixes.

            - Frontend build: ✅ Pass
            - Functions build: ✅ Pass

            The Renovate PR is ready for review and merge."
          else
            MESSAGE="⚠️ **Migration incomplete**

            Some builds are still failing after Claude Code's attempted fixes:

            - Frontend build: $([ "$FRONTEND_STATUS" == "success" ] && echo "✅ Pass" || echo "❌ Fail")
            - Functions build: $([ "$FUNCTIONS_STATUS" == "success" ] && echo "✅ Pass" || echo "❌ Fail")

            Manual intervention may be required. Check the workflow logs for details."
          fi

          gh pr comment ${{ needs.check-conditions.outputs.pr_number }} --body "$MESSAGE"
        env:
          GH_TOKEN: ${{ github.token }}
